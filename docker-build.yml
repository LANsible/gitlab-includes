---
.build:
  tags:
    - docker
  variables:
    BUILDX_VERSION: 0.3.1

    # Set variables to enable buildx plugin
    DOCKER_CLI_EXPERIMENTAL: enabled
    DOCKER_BUILDKIT: 1

    # To make it possible to pass args from a downstream include
    DOCKER_BUILD_ARGS: ""
    DOCKER_BUILD_PLATFORMS: linux/arm64/v8,linux/amd64,linux/arm/v6,linux/arm/v7,linux/386

    # Default push to internal Gitlab registry
    DOCKER_IMAGE_NAME: ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_SLUG}
    DOCKER_IMAGE_TAG: ${CI_COMMIT_SHA}

  script:
    # Setup buildx
    - docker build --platform=local -o . git://github.com/docker/buildx
    - mv buildx ~/.docker/cli-plugins/docker-buildx
    - docker run --rm --privileged hypriot/qemu-register
    - docker buildx create --use

    # Build and push container
    - if [ -z "$DOCKER_BUILD_ARGS" ]; then
        docker buildx build
        --platform ${DOCKER_BUILD_PLATFORMS}
        --tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
        --push .;
      else
        docker buildx build
        --platform ${DOCKER_BUILD_PLATFORMS}
        --build-args "${DOCKER_BUILD_ARGS}"
        --tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
        --push .;
      fi

# Build stage
build:
  extends: .build
  stage: build
  variables:
    # Only build amd64 for the test stages
    DOCKER_BUILD_PLATFORMS: linux/amd64

# Publish branch image
publish_branch:
  extends: .build
  stage: publish
  only:
    - branches
  variables:
    DOCKER_IMAGE_TAG: ${CI_COMMIT_REF_SLUG}

# Publish tagged release
publish_tag:
  extends: .build
  stage: publish
  only:
    - tags
  except:
    - branches
  variables:
    DOCKER_IMAGE_TAG: ${CI_COMMIT_TAG}

# Publish tagged release
publish_latest:
  extends: .build
  stage: publish
  only:
    - tags
  except:
    - branches
  variables:
    DOCKER_IMAGE_TAG: latest
